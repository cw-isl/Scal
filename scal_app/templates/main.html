<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Smart Frame Landing</title>
<style>
  :root {
    color-scheme: light dark;
    font-family: 'Noto Sans KR', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
  }
  * { box-sizing:border-box; }
  body {
    margin:0;
    background:linear-gradient(180deg,#f2f5fb 0%, #eef1f7 45%, #ffffff 100%);
    color:#14213d;
    min-height:100vh;
    display:flex;
    flex-direction:column;
  }
  .navbar {
    background:#243b6b;
    color:#fff;
    padding:14px 28px;
    display:flex;
    align-items:center;
    gap:28px;
    position:sticky;
    top:0;
    z-index:10;
    box-shadow:0 8px 18px rgba(20,33,61,0.18);
  }
  .navbar-brand {
    font-weight:700;
    font-size:20px;
    letter-spacing:0.02em;
  }
  .nav-menu {
    display:flex;
    align-items:center;
    gap:18px;
    list-style:none;
    margin:0;
    padding:0;
  }
  .menu-item {
    position:relative;
  }
  .menu-trigger {
    display:flex;
    align-items:center;
    gap:6px;
    border:none;
    background:transparent;
    color:inherit;
    font:600 15px/1 'Noto Sans KR', sans-serif;
    cursor:pointer;
    padding:8px 12px;
    border-radius:10px;
    transition:background 0.18s ease;
  }
  .menu-trigger:hover,
  .menu-trigger:focus-visible {
    background:rgba(255,255,255,0.18);
    outline:none;
  }
  .menu-trigger svg {
    width:14px;
    height:14px;
    fill:currentColor;
  }
  .dropdown {
    position:absolute;
    top:calc(100% + 6px);
    left:0;
    background:#ffffff;
    color:#1f2a44;
    min-width:180px;
    border-radius:12px;
    padding:10px 0;
    box-shadow:0 18px 36px rgba(19,34,72,0.18);
    opacity:0;
    pointer-events:none;
    transform:translateY(-6px);
    transition:opacity 0.18s ease, transform 0.18s ease;
  }
  .menu-item:focus-within .dropdown,
  .menu-item:hover .dropdown {
    opacity:1;
    pointer-events:auto;
    transform:translateY(0);
  }
  .dropdown a {
    display:flex;
    align-items:center;
    padding:10px 18px;
    font-size:14px;
    color:inherit;
    text-decoration:none;
    gap:10px;
    transition:background 0.15s ease, color 0.15s ease;
  }
  .dropdown a:hover,
  .dropdown a:focus-visible {
    background:#eef2ff;
    color:#1a2f6b;
    outline:none;
  }
  .main-content {
    flex:1 1 auto;
    display:flex;
    flex-direction:column;
  }
  .hero {
    display:flex;
    align-items:center;
    justify-content:center;
    padding:80px 24px 40px;
  }
  .hero-card {
    background:rgba(255,255,255,0.88);
    border-radius:28px;
    padding:48px 60px;
    max-width:680px;
    text-align:center;
    box-shadow:0 24px 48px rgba(20,33,61,0.16);
    backdrop-filter:blur(6px);
  }
  .hero-card h1 {
    margin:0;
    font-size:34px;
    font-weight:700;
    color:#1c2f57;
  }
  .hero-card p {
    margin:18px 0 0;
    font-size:16px;
    line-height:1.6;
    color:#44516d;
  }
  .dashboard {
    padding:0 24px 60px;
  }
  .dash-grid {
    margin:0 auto;
    width:100%;
    max-width:960px;
    display:grid;
    gap:24px;
    grid-template-columns:repeat(auto-fit, minmax(300px, 1fr));
  }
  .panel {
    background:rgba(255,255,255,0.92);
    border-radius:24px;
    padding:28px 30px;
    box-shadow:0 22px 42px rgba(20,33,61,0.14);
    display:flex;
    flex-direction:column;
    gap:18px;
  }
  .panel-header h2 {
    margin:0;
    font-size:22px;
    font-weight:700;
    color:#1c2f57;
  }
  .panel-header p {
    margin:6px 0 0;
    font-size:14px;
    color:#4a5678;
  }
  .panel form {
    display:flex;
    flex-direction:column;
    gap:12px;
  }
  .panel label {
    font-size:14px;
    font-weight:600;
    color:#2d395b;
  }
  .panel textarea {
    border:1px solid rgba(0,0,0,0.12);
    border-radius:12px;
    padding:12px 14px;
    font-size:15px;
    min-height:120px;
    resize:vertical;
    transition:border-color .2s, box-shadow .2s;
  }
  .panel textarea:focus {
    outline:none;
    border-color:#4b6bff;
    box-shadow:0 0 0 3px rgba(75,107,255,0.18);
  }
  .panel-actions {
    display:flex;
    flex-wrap:wrap;
    align-items:center;
    gap:10px;
  }
  .panel-status {
    font-size:13px;
    color:#2d7f2d;
  }
  .panel-status.error {
    color:#c62828;
  }
  .btn,
  button {
    border:none;
    background:#4b6bff;
    color:#fff;
    padding:10px 18px;
    border-radius:12px;
    font-size:14px;
    font-weight:600;
    cursor:pointer;
    transition:transform .15s ease, box-shadow .15s ease, background .15s ease;
  }
  .btn:hover,
  button:hover {
    background:#3957f6;
    box-shadow:0 12px 22px rgba(75,107,255,0.18);
  }
  .btn:active,
  button:active {
    transform:translateY(1px);
  }
  .btn-secondary {
    background:#eef1ff;
    color:#2a3570;
  }
  .btn-secondary:hover {
    background:#dbe1ff;
  }
  .input-row {
    display:flex;
    flex-wrap:wrap;
    gap:10px;
    align-items:center;
  }
  .upload-area {
    border:2px dashed rgba(75,107,255,0.28);
    border-radius:18px;
    padding:20px;
    background:#f6f8ff;
    display:flex;
    flex-direction:column;
    gap:14px;
    transition:border-color .2s ease, background .2s ease, box-shadow .2s ease;
  }
  .upload-area.dragover {
    border-color:#4b6bff;
    background:rgba(75,107,255,0.08);
    box-shadow:0 14px 26px rgba(75,107,255,0.18);
  }
  .upload-area input[type="file"] {
    display:none;
  }
  .upload-summary {
    font-size:13px;
    color:#2d3a6b;
    background:#eef1ff;
    border-radius:12px;
    padding:10px 12px;
    line-height:1.4;
  }
  .upload-summary strong {
    display:block;
    margin-bottom:4px;
  }
  .photos-grid {
    display:grid;
    grid-template-columns:repeat(auto-fit, minmax(160px, 1fr));
    gap:12px;
  }
  .photo-item {
    background:#f6f7fb;
    border-radius:14px;
    padding:12px;
    display:flex;
    flex-direction:column;
    gap:10px;
  }
  .photo-item img {
    width:100%;
    height:120px;
    object-fit:cover;
    border-radius:10px;
  }
  .photo-item .name {
    font-size:13px;
    color:#333;
    word-break:break-all;
  }
  .photo-item .actions {
    display:flex;
    gap:8px;
  }
  .photo-item .actions button {
    flex:1 1 auto;
    padding:8px 10px;
    font-size:13px;
  }
  .todo-panel-body {
    display:flex;
    flex-direction:column;
    gap:16px;
  }
  .todo-toolbar {
    display:flex;
    justify-content:space-between;
    align-items:center;
    gap:12px;
  }
  .todo-toolbar .btn {
    margin-left:auto;
  }
  .todo-message {
    font-size:14px;
    color:#1c4a6e;
    background:#eef6ff;
    border-radius:12px;
    padding:10px 14px;
  }
  .todo-message[hidden] {
    display:none;
  }
  .todo-message.error {
    background:#ffecec;
    color:#c62828;
  }
  .todo-message.warning {
    background:#fff4e5;
    color:#e65100;
  }
  .todo-list {
    display:flex;
    flex-direction:column;
    gap:12px;
  }
  .todo-item {
    display:flex;
    align-items:flex-start;
    gap:12px;
    padding:14px 16px;
    border-radius:16px;
    background:#f6f8ff;
    border:1px solid rgba(75,107,255,0.14);
    transition:box-shadow .2s ease, transform .2s ease;
  }
  .todo-item:hover {
    box-shadow:0 16px 28px rgba(20,33,61,0.12);
    transform:translateY(-1px);
  }
  .todo-item.completed {
    opacity:0.65;
  }
  .todo-item.overdue {
    border-color:rgba(230,81,0,0.35);
    box-shadow:0 12px 26px rgba(230,81,0,0.15);
  }
  .todo-item input[type="checkbox"] {
    width:18px;
    height:18px;
    accent-color:#4b6bff;
    margin-top:2px;
  }
  .todo-item .title {
    flex:1 1 auto;
    white-space:pre-wrap;
    word-break:keep-all;
    line-height:1.45;
    color:#2d395b;
  }
  .todo-item .due {
    font-weight:600;
    font-size:13px;
    color:#4a5678;
    min-width:84px;
    text-align:right;
  }
  .todo-item .actions {
    display:flex;
    gap:8px;
  }
  .todo-item .actions button {
    padding:6px 12px;
    border-radius:10px;
    font-size:13px;
    background:#eef1ff;
    color:#2a3570;
    border:none;
    cursor:pointer;
    transition:background .2s ease, transform .2s ease;
  }
  .todo-item .actions button:hover {
    background:#dbe1ff;
  }
  .todo-item .actions button:active {
    transform:translateY(1px);
  }
  .todo-item .actions button.danger {
    background:#ffecec;
    color:#c62828;
  }
  .todo-item .actions button.danger:hover {
    background:#ffd6d6;
  }
  .todo-empty {
    font-size:14px;
    color:#5a678a;
  }
  .todo-modal[hidden] {
    display:none;
  }
  .todo-modal {
    position:fixed;
    inset:0;
    background:rgba(20,33,61,0.35);
    display:flex;
    align-items:center;
    justify-content:center;
    padding:20px;
    z-index:1200;
  }
  .todo-modal-dialog {
    background:#ffffff;
    border-radius:20px;
    padding:26px 28px;
    width:100%;
    max-width:440px;
    box-shadow:0 24px 48px rgba(20,33,61,0.25);
    display:flex;
    flex-direction:column;
    gap:18px;
  }
  .todo-modal-dialog h3 {
    margin:0;
    font-size:20px;
    color:#1c2f57;
  }
  .todo-modal-dialog label {
    font-size:14px;
    font-weight:600;
    color:#2d395b;
    margin-bottom:6px;
    display:block;
  }
  .todo-modal-dialog textarea {
    width:100%;
    min-height:110px;
    resize:vertical;
    border-radius:14px;
    border:1px solid rgba(20,33,61,0.18);
    padding:12px 14px;
    font-family:inherit;
    font-size:15px;
  }
  .todo-modal-dialog input[type="date"] {
    width:100%;
    border-radius:14px;
    border:1px solid rgba(20,33,61,0.18);
    padding:10px 14px;
    font-size:15px;
  }
  .todo-modal-error {
    font-size:14px;
    color:#c62828;
  }
  .todo-modal-error[hidden] {
    display:none;
  }
  .todo-modal-actions {
    display:flex;
    justify-content:flex-end;
    gap:10px;
  }
  .muted {
    font-size:13px;
    color:#5a678a;
  }
  footer {
    text-align:center;
    padding:20px;
    font-size:13px;
    color:#59668b;
  }
  @media (max-width:640px) {
    .navbar {
      flex-wrap:wrap;
      gap:14px;
      padding:14px 18px;
    }
    .hero-card {
      padding:36px 28px;
    }
    .hero-card h1 {
      font-size:28px;
    }
    .dash-grid {
      grid-template-columns:1fr;
    }
  }
</style>
</head>
<body>
  <nav class="navbar">
    <div class="navbar-brand">Scal Dashboard</div>
    <ul class="nav-menu">
      <li class="menu-item">
        <button class="menu-trigger" type="button" aria-haspopup="true" aria-expanded="false">
          스마트 프레임
          <svg viewBox="0 0 16 16" aria-hidden="true"><path d="M3.2 5.6a.8.8 0 0 1 1.12-.16L8 8.13l3.68-2.69a.8.8 0 1 1 .96 1.28l-4.16 3.04a.8.8 0 0 1-.96 0L3.36 6.72a.8.8 0 0 1-.16-1.12Z"/></svg>
        </button>
        <div class="dropdown" role="menu">
          <a href="/board" role="menuitem">View</a>
          <a href="/board?view=mobile" role="menuitem">Mobile layout 보기</a>
          <a href="/settings#keys-settings" role="menuitem">Keys settings</a>
          <a href="/settings#ui-settings" role="menuitem">UI settings</a>
          <a href="http://ttms03.duckdns.org:5320/board?rotate=right" target="_blank" rel="noopener" role="menuitem">Rotate right</a>
          <a href="http://ttms03.duckdns.org:5320/board?rotate=left" target="_blank" rel="noopener" role="menuitem">Rotate left</a>
        </div>
      </li>
      <li class="menu-item">
        <button class="menu-trigger" type="button" aria-haspopup="true" aria-expanded="false">
          홈 어시스턴트
          <svg viewBox="0 0 16 16" aria-hidden="true"><path d="M3.2 5.6a.8.8 0 0 1 1.12-.16L8 8.13l3.68-2.69a.8.8 0 1 1 .96 1.28l-4.16 3.04a.8.8 0 0 1-.96 0L3.36 6.72a.8.8 0 0 1-.16-1.12Z"/></svg>
        </button>
        <div class="dropdown" role="menu">
          <a href="http://ttms03.duckdns.org:8123/config/integrations/dashboard" target="_blank" rel="noopener" role="menuitem">add device</a>
        </div>
      </li>
    </ul>
  </nav>
  <main class="main-content">
    <section class="hero">
      <div class="hero-card">
        <h1>Smart Frame &amp; Home Assistant 허브</h1>
        <p>상단 메뉴에서 Smart Frame 보드와 설정, 그리고 홈 어시스턴트 연동 페이지로 이동하세요. 아래 패널에서 오늘의 한마디와 사진을 바로 관리할 수 있습니다.</p>
      </div>
    </section>
    <section class="dashboard">
      <div class="dash-grid">
        <article class="panel" id="verse-panel">
          <header class="panel-header">
            <h2>오늘의 한마디</h2>
            <p>Smart Frame 보드에 표시될 문구를 즉시 수정하세요.</p>
          </header>
          <form id="verse-form">
            <label for="verse-text">문구</label>
            <textarea id="verse-text" placeholder="따뜻한 문장을 입력하세요"></textarea>
            <div class="panel-actions">
              <button type="submit" class="btn">저장</button>
              <span class="panel-status" id="verse-status" hidden></span>
            </div>
          </form>
        </article>
        <article class="panel" id="todo-panel">
          <header class="panel-header">
            <h2>할 일 관리</h2>
            <p>Smart Frame Todo를 등록하고 정리하세요.</p>
          </header>
          <div class="todo-panel-body">
            <div class="todo-toolbar">
              <span class="muted">추가한 항목이 Smart Frame에 바로 반영됩니다.</span>
              <button type="button" class="btn" id="todo-add-btn">+ 할 일 추가</button>
            </div>
            <div class="todo-message" id="todo-message" hidden></div>
            <div class="todo-list" id="todo-list"></div>
          </div>
        </article>
        <article class="panel" id="photos-panel">
          <header class="panel-header">
            <h2>사진 업로드</h2>
            <p>보드 배경으로 사용할 이미지를 업로드하거나 삭제하세요.</p>
          </header>
          <div class="upload-area" id="photo-dropzone">
            <input id="photo-upload" type="file" accept="image/*" multiple/>
            <p class="muted upload-hint">사진을 선택하거나 이 영역으로 드래그해서 추가하세요.</p>
            <div class="input-row">
              <button type="button" class="btn-secondary" data-action="choose-photo">사진 선택</button>
              <button type="button" class="btn" data-action="upload-photo">업로드</button>
            </div>
            <div class="upload-summary" id="photo-upload-summary" hidden></div>
          </div>
          <div class="panel-actions">
            <button type="button" class="btn-secondary" data-action="refresh-photos">목록 새로고침</button>
            <span class="panel-status" id="photos-status" hidden></span>
          </div>
          <div class="photos-grid" id="photos-grid"></div>
        </article>
      </div>
    </section>
  </main>
  <div class="todo-modal" id="todo-modal" hidden>
    <div class="todo-modal-dialog" role="dialog" aria-modal="true" aria-labelledby="todo-modal-title">
      <form id="todo-form">
        <h3 id="todo-modal-title">할 일 추가</h3>
        <div>
          <label for="todo-title-input">내용</label>
          <textarea id="todo-title-input" name="title" maxlength="500" placeholder="할 일을 입력하세요" required></textarea>
        </div>
        <div>
          <label for="todo-date-input">날짜</label>
          <input id="todo-date-input" name="due_date" type="date"/>
        </div>
        <div class="todo-modal-error" id="todo-modal-error" hidden></div>
        <div class="todo-modal-actions">
          <button type="button" class="btn-secondary" id="todo-cancel-btn">취소</button>
          <button type="submit" class="btn">저장</button>
        </div>
      </form>
    </div>
  </div>
  <footer>© Smart Frame</footer>
  <script>
    const verseForm = document.getElementById('verse-form');
    const verseInput = document.getElementById('verse-text');
    const verseStatus = document.getElementById('verse-status');

    const photoInput = document.getElementById('photo-upload');
    const photoDropzone = document.getElementById('photo-dropzone');
    const photoSummary = document.getElementById('photo-upload-summary');
    const photosStatus = document.getElementById('photos-status');
    const photosGrid = document.getElementById('photos-grid');

    const uploadQueue = [];

    function setPanelStatus(target, message, isError = false) {
      const el = typeof target === 'string' ? document.getElementById(target) : target;
      if (!el) return;
      if (!message) {
        el.textContent = '';
        el.hidden = true;
        el.classList.remove('error');
        return;
      }
      el.hidden = false;
      el.textContent = message;
      el.classList.toggle('error', Boolean(isError));
    }

    async function loadVerse() {
      if (!verseInput) return;
      try {
        const res = await fetch('/api/verse');
        if (!res.ok) throw new Error('문구를 불러오지 못했습니다.');
        const data = await res.json();
        verseInput.value = data?.text || '';
        setPanelStatus(verseStatus, '');
      } catch (err) {
        setPanelStatus(verseStatus, err.message || '문구를 불러오지 못했습니다.', true);
      }
    }

    if (verseForm) {
      verseForm.addEventListener('submit', async (event) => {
        event.preventDefault();
        if (!verseInput) return;
        setPanelStatus(verseStatus, '저장 중...');
        try {
          const res = await fetch('/api/verse', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ text: verseInput.value.trim() }),
          });
          const body = await res.json().catch(() => ({}));
          if (!res.ok || body?.error) {
            throw new Error(body?.error || '저장 실패');
          }
          setPanelStatus(verseStatus, '저장되었습니다.');
        } catch (err) {
          setPanelStatus(verseStatus, err.message || '저장 실패', true);
        }
      });
    }

    function isImageFile(file) {
      if (!file) return false;
      if (file.type && file.type.startsWith('image/')) return true;
      const name = file.name || '';
      return /\.(jpe?g|png|gif|webp|bmp)$/i.test(name);
    }

    function updateUploadSummary() {
      if (!photoSummary) return;
      photoSummary.innerHTML = '';
      if (!uploadQueue.length) {
        photoSummary.hidden = true;
        return;
      }
      const title = document.createElement('strong');
      title.textContent = `${uploadQueue.length}개의 파일이 대기 중입니다.`;
      photoSummary.appendChild(title);
      uploadQueue.slice(0, 3).forEach((file) => {
        const row = document.createElement('div');
        row.textContent = `• ${file.name}`;
        photoSummary.appendChild(row);
      });
      if (uploadQueue.length > 3) {
        const more = document.createElement('div');
        more.textContent = `… 외 ${uploadQueue.length - 3}개`;
        photoSummary.appendChild(more);
      }
      photoSummary.hidden = false;
    }

    function addFilesToQueue(files) {
      if (!files || !files.length) {
        return { added: 0, skipped: 0 };
      }
      let added = 0;
      let skipped = 0;
      files.forEach((file) => {
        if (isImageFile(file)) {
          uploadQueue.push(file);
          added += 1;
        } else {
          skipped += 1;
        }
      });
      if (added) updateUploadSummary();
      return { added, skipped };
    }

    function handleQueueResult(result) {
      if (!result) return;
      const { added, skipped } = result;
      if (!added && !skipped) return;
      const messages = [];
      if (added) messages.push(`${uploadQueue.length}개의 파일이 대기 중입니다.`);
      if (skipped) messages.push(`${skipped}개의 파일은 지원되지 않는 형식입니다.`);
      setPanelStatus(photosStatus, messages.join(' '), skipped > 0 && !added);
      if (!added) updateUploadSummary();
    }

    function encodePhotoPath(name) {
      return name.split('/').map(encodeURIComponent).join('/');
    }

    function renderPhotos(list) {
      if (!photosGrid) return;
      photosGrid.innerHTML = '';
      if (!list.length) {
        const empty = document.createElement('p');
        empty.className = 'muted';
        empty.textContent = '등록된 사진이 없습니다.';
        photosGrid.appendChild(empty);
        return;
      }
      list.forEach((name) => {
        const item = document.createElement('div');
        item.className = 'photo-item';
        const img = document.createElement('img');
        img.src = `/photos/${encodePhotoPath(name)}`;
        img.alt = name;
        img.loading = 'lazy';
        const title = document.createElement('div');
        title.className = 'name';
        title.textContent = name;
        const actions = document.createElement('div');
        actions.className = 'actions';
        const openBtn = document.createElement('button');
        openBtn.type = 'button';
        openBtn.className = 'btn-secondary';
        openBtn.textContent = '보기';
        openBtn.addEventListener('click', () => {
          window.open(`/photos/${encodePhotoPath(name)}`, '_blank');
        });
        const delBtn = document.createElement('button');
        delBtn.type = 'button';
        delBtn.textContent = '삭제';
        delBtn.addEventListener('click', () => deletePhoto(name));
        actions.append(openBtn, delBtn);
        item.append(img, title, actions);
        photosGrid.appendChild(item);
      });
    }

    async function loadPhotos(options) {
      const opts = options instanceof Event ? {} : (options || {});
      const { silent = false } = opts;
      try {
        const res = await fetch('/api/photos', { cache: 'no-store' });
        if (!res.ok) throw new Error('사진 목록을 불러오지 못했습니다.');
        const photos = await res.json();
        renderPhotos(photos || []);
        if (!silent) {
          setPanelStatus(photosStatus, `${photos.length}개의 사진을 불러왔습니다.`);
        }
        return photos;
      } catch (err) {
        if (!silent) {
          setPanelStatus(photosStatus, err.message || '사진 목록을 불러오지 못했습니다.', true);
        }
        return null;
      }
    }

    async function uploadPhoto() {
      if (photoInput && photoInput.files && photoInput.files.length) {
        const result = addFilesToQueue(Array.from(photoInput.files));
        handleQueueResult(result);
        photoInput.value = '';
      }
      if (!uploadQueue.length) {
        setPanelStatus(photosStatus, '업로드할 파일을 추가하세요.', true);
        return;
      }

      const files = uploadQueue.slice();
      uploadQueue.length = 0;
      updateUploadSummary();

      setPanelStatus(photosStatus, '업로드 중...');
      const failures = [];
      let successCount = 0;

      for (const file of files) {
        const formData = new FormData();
        formData.append('photo', file);
        try {
          const res = await fetch('/api/photos/upload', {
            method: 'POST',
            body: formData,
          });
          const body = await res.json().catch(() => ({}));
          if (!res.ok || body?.error) {
            throw new Error(body?.error || '업로드 실패');
          }
          successCount += 1;
        } catch (err) {
          failures.push({ file, error: err });
        }
      }

      let message = '';
      let isError = false;

      if (failures.length) {
        failures.forEach(({ file }) => uploadQueue.push(file));
        updateUploadSummary();
        const firstError = failures[0].error?.message || '업로드 실패';
        if (!successCount) {
          message = `모든 파일 업로드에 실패했습니다. (${firstError})`;
          isError = true;
        } else {
          message = `${successCount}개 업로드 완료, ${failures.length}개 실패 (${firstError})`;
          isError = true;
        }
      } else {
        message = `${successCount}개 파일 업로드 완료!`;
      }

      if (successCount) {
        await loadPhotos({ silent: true });
      }

      setPanelStatus(photosStatus, message, isError);
    }

    async function deletePhoto(name) {
      if (!confirm(`${name}\n사진을 삭제하시겠습니까?`)) return;
      setPanelStatus(photosStatus, '삭제 중...');
      try {
        const res = await fetch(`/api/photos/${encodePhotoPath(name)}`, { method: 'DELETE' });
        const body = await res.json().catch(() => ({}));
        if (!res.ok || body?.error) {
          throw new Error(body?.error || '삭제 실패');
        }
        setPanelStatus(photosStatus, '삭제되었습니다.');
        await loadPhotos({ silent: true });
      } catch (err) {
        setPanelStatus(photosStatus, err.message || '삭제 실패', true);
      }
    }

    if (photoInput) {
      photoInput.multiple = true;
      photoInput.addEventListener('change', (event) => {
        const files = Array.from(event.target.files || []);
        const result = addFilesToQueue(files);
        handleQueueResult(result);
        photoInput.value = '';
      });
    }

    const chooseButton = document.querySelector('[data-action="choose-photo"]');
    if (chooseButton && photoInput) {
      chooseButton.addEventListener('click', () => photoInput.click());
    }

    const uploadButton = document.querySelector('[data-action="upload-photo"]');
    if (uploadButton) {
      uploadButton.addEventListener('click', uploadPhoto);
    }

    const refreshButton = document.querySelector('[data-action="refresh-photos"]');
    if (refreshButton) {
      refreshButton.addEventListener('click', () => loadPhotos({ silent: false }));
    }

    if (photoDropzone) {
      let dragCounter = 0;
      photoDropzone.addEventListener('dragenter', (event) => {
        event.preventDefault();
        dragCounter += 1;
        photoDropzone.classList.add('dragover');
      });
      photoDropzone.addEventListener('dragover', (event) => {
        event.preventDefault();
        if (event.dataTransfer) {
          event.dataTransfer.dropEffect = 'copy';
        }
      });
      photoDropzone.addEventListener('dragleave', () => {
        dragCounter = Math.max(0, dragCounter - 1);
        if (dragCounter === 0) {
          photoDropzone.classList.remove('dragover');
        }
      });
      photoDropzone.addEventListener('drop', (event) => {
        event.preventDefault();
        dragCounter = 0;
        photoDropzone.classList.remove('dragover');
        const files = Array.from(event.dataTransfer?.files || []);
        const result = addFilesToQueue(files);
        handleQueueResult(result);
      });
      photoDropzone.addEventListener('click', (event) => {
        if (event.target === photoDropzone || event.target.classList.contains('upload-hint')) {
          photoInput?.click();
        }
      });
    }

    window.addEventListener('dragover', (event) => {
      if (!photoDropzone) return;
      if (!photoDropzone.contains(event.target)) {
        event.preventDefault();
      }
    });

    window.addEventListener('drop', (event) => {
      if (!photoDropzone) return;
      if (!photoDropzone.contains(event.target)) {
        event.preventDefault();
      }
    });

    (function initDashboardTodo() {
      const todoListEl = document.getElementById('todo-list');
      const todoMessageEl = document.getElementById('todo-message');
      const todoAddBtn = document.getElementById('todo-add-btn');
      const todoModal = document.getElementById('todo-modal');
      const todoForm = document.getElementById('todo-form');
      const todoTitleInput = document.getElementById('todo-title-input');
      const todoDateInput = document.getElementById('todo-date-input');
      const todoModalTitle = document.getElementById('todo-modal-title');
      const todoModalError = document.getElementById('todo-modal-error');
      const todoCancelBtn = document.getElementById('todo-cancel-btn');

      if (!todoListEl || !todoAddBtn || !todoModal || !todoForm) {
        return;
      }

      let todoItems = [];
      let editingTodoId = null;

      function setTodoMessage(text, type = 'info') {
        if (!todoMessageEl) return;
        if (!text) {
          todoMessageEl.textContent = '';
          todoMessageEl.hidden = true;
          todoMessageEl.classList.remove('error', 'warning');
          return;
        }
        todoMessageEl.hidden = false;
        todoMessageEl.textContent = text;
        todoMessageEl.classList.remove('error', 'warning');
        if (type === 'error') {
          todoMessageEl.classList.add('error');
        } else if (type === 'warning') {
          todoMessageEl.classList.add('warning');
        }
      }

      function normalizeTodoItems(items) {
        if (!Array.isArray(items)) return [];
        return items.slice();
      }

      function parseDueDate(value) {
        if (!value) return null;
        const parts = value.split('-');
        if (parts.length !== 3) return null;
        const d = new Date(`${value}T00:00:00`);
        if (Number.isNaN(d.getTime())) return null;
        return new Date(d.getFullYear(), d.getMonth(), d.getDate());
      }

      function isOverdue(item) {
        if (!item || !item.due_date || item.completed) return false;
        const due = parseDueDate(item.due_date);
        if (!due) return false;
        const now = new Date();
        const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
        return due < today;
      }

      function formatTodoDate(value) {
        if (!value) return '';
        const parts = value.split('-');
        if (parts.length === 3) {
          return `${parts[0]}.${parts[1]}.${parts[2]}`;
        }
        return value;
      }

      function closeTodoModal() {
        if (!todoModal) return;
        editingTodoId = null;
        todoForm.reset();
        if (todoModalError) {
          todoModalError.textContent = '';
          todoModalError.hidden = true;
        }
        todoModal.setAttribute('hidden', 'true');
      }

      function openTodoModal(item) {
        if (!todoModal) return;
        editingTodoId = item && item.id ? item.id : null;
        if (todoModalTitle) {
          todoModalTitle.textContent = editingTodoId ? '할 일 수정' : '할 일 추가';
        }
        if (todoTitleInput) {
          todoTitleInput.value = item && item.title ? item.title : '';
        }
        if (todoDateInput) {
          todoDateInput.value = item && item.due_date ? item.due_date : '';
        }
        if (todoModalError) {
          todoModalError.textContent = '';
          todoModalError.hidden = true;
        }
        todoModal.removeAttribute('hidden');
        setTimeout(() => todoTitleInput?.focus(), 10);
      }

      function renderTodoItems() {
        if (!todoListEl) return;
        todoListEl.innerHTML = '';
        if (!Array.isArray(todoItems) || todoItems.length === 0) {
          const empty = document.createElement('div');
          empty.className = 'todo-empty';
          empty.textContent = '등록된 할 일이 없습니다. "할 일 추가" 버튼으로 새 항목을 만들어보세요.';
          todoListEl.appendChild(empty);
          return;
        }
        let hasOverdue = false;
        todoItems.forEach((item) => {
          const row = document.createElement('div');
          row.className = 'todo-item';
          if (item.completed) row.classList.add('completed');
          if (isOverdue(item)) {
            row.classList.add('overdue');
            hasOverdue = true;
          }

          const checkbox = document.createElement('input');
          checkbox.type = 'checkbox';
          checkbox.checked = !!item.completed;
          checkbox.addEventListener('change', () => toggleTodoCompletion(item, checkbox, checkbox.checked));
          row.appendChild(checkbox);

          const title = document.createElement('div');
          title.className = 'title';
          title.textContent = item.title || '(제목 없음)';
          row.appendChild(title);

          const due = document.createElement('div');
          due.className = 'due';
          due.textContent = item.due_date ? formatTodoDate(item.due_date) : '';
          row.appendChild(due);

          const actions = document.createElement('div');
          actions.className = 'actions';
          const editBtn = document.createElement('button');
          editBtn.type = 'button';
          editBtn.textContent = '수정';
          editBtn.addEventListener('click', () => openTodoModal(item));
          const deleteBtn = document.createElement('button');
          deleteBtn.type = 'button';
          deleteBtn.textContent = '삭제';
          deleteBtn.classList.add('danger');
          deleteBtn.addEventListener('click', () => confirmDeleteTodo(item));
          actions.appendChild(editBtn);
          actions.appendChild(deleteBtn);
          row.appendChild(actions);

          todoListEl.appendChild(row);
        });
        if (hasOverdue) {
          setTodoMessage('기한이 지난 할 일이 있습니다.', 'warning');
        }
      }

      async function fetchTodoItems() {
        setTodoMessage('할 일을 불러오는 중입니다...');
        try {
          const res = await fetch('/api/todo');
          const data = await res.json();
          if (!res.ok) {
            throw new Error(data.error || '할 일을 불러오지 못했습니다.');
          }
          todoItems = normalizeTodoItems(data.items);
          setTodoMessage('');
          renderTodoItems();
        } catch (err) {
          console.error('Failed to load todo list', err);
          setTodoMessage(err.message || '할 일을 불러오지 못했습니다.', 'error');
        }
      }

      async function requestTodoUpdate(url, method, payload) {
        const res = await fetch(url, {
          method,
          headers: { 'Content-Type': 'application/json' },
          body: payload ? JSON.stringify(payload) : undefined,
        });
        const data = await res.json().catch(() => ({}));
        if (!res.ok) {
          throw new Error(data.error || '요청을 처리하지 못했습니다.');
        }
        if (Array.isArray(data.items)) {
          todoItems = normalizeTodoItems(data.items);
          renderTodoItems();
        }
        return data;
      }

      async function toggleTodoCompletion(item, checkbox, desired) {
        try {
          await requestTodoUpdate(`/api/todo/${item.id}`, 'PATCH', { completed: desired });
          setTodoMessage('할 일 상태를 갱신했습니다.');
        } catch (err) {
          console.error('Failed to update todo', err);
          if (checkbox) checkbox.checked = !desired;
          setTodoMessage(err.message || '할 일을 갱신하지 못했습니다.', 'error');
        }
      }

      function confirmDeleteTodo(item) {
        if (!item || !item.id) return;
        if (!window.confirm('이 할 일을 삭제할까요?')) return;
        deleteTodo(item.id);
      }

      async function deleteTodo(id) {
        try {
          await requestTodoUpdate(`/api/todo/${id}`, 'DELETE');
          if (todoItems.length === 0) {
            setTodoMessage('등록된 할 일이 없습니다. 새로운 할 일을 추가해보세요.');
          } else {
            setTodoMessage('할 일을 삭제했습니다.');
          }
        } catch (err) {
          console.error('Failed to delete todo', err);
          setTodoMessage(err.message || '할 일을 삭제하지 못했습니다.', 'error');
        }
      }

      async function handleTodoSubmit(event) {
        event.preventDefault();
        const title = todoTitleInput ? todoTitleInput.value.trim() : '';
        const dueDate = todoDateInput ? todoDateInput.value.trim() : '';
        if (!title) {
          if (todoModalError) {
            todoModalError.textContent = '할 일 내용을 입력하세요.';
            todoModalError.hidden = false;
          }
          todoTitleInput?.focus();
          return;
        }
        const payload = { title, due_date: dueDate };
        const method = editingTodoId ? 'PATCH' : 'POST';
        const url = editingTodoId ? `/api/todo/${editingTodoId}` : '/api/todo';
        try {
          if (todoModalError) {
            todoModalError.textContent = '';
            todoModalError.hidden = true;
          }
          setTodoMessage('저장 중입니다...');
          await requestTodoUpdate(url, method, payload);
          closeTodoModal();
          setTodoMessage('할 일을 저장했습니다.');
        } catch (err) {
          console.error('Failed to save todo', err);
          if (todoModalError) {
            todoModalError.textContent = err.message || '할 일을 저장하지 못했습니다.';
            todoModalError.hidden = false;
          }
          setTodoMessage(err.message || '할 일을 저장하지 못했습니다.', 'error');
        }
      }

      todoAddBtn.addEventListener('click', () => openTodoModal(null));
      if (todoCancelBtn) {
        todoCancelBtn.addEventListener('click', (event) => {
          event.preventDefault();
          closeTodoModal();
        });
      }
      todoForm.addEventListener('submit', handleTodoSubmit);
      todoModal.addEventListener('click', (event) => {
        if (event.target === todoModal) {
          closeTodoModal();
        }
      });
      document.addEventListener('keydown', (event) => {
        if (event.key === 'Escape' && !todoModal.hasAttribute('hidden')) {
          closeTodoModal();
        }
      });

      fetchTodoItems();
      setInterval(fetchTodoItems, 60 * 1000);
    })();

    loadVerse();
    loadPhotos({ silent: false });
  </script>
</body>
</html>
